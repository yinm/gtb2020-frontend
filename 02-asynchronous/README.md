# 非同期プログラミング

## 同期処理・非同期処理
プログラミング言語のコードの評価の仕方の分類として、同期処理・非同期処理があります。JSにおいてもどちらも存在するため、それぞれを詳しく見ていきます。

### 同期処理とは
特徴
- ひとつの処理が終わるまで、次の処理を行わない
- コードの記述を上から順番に処理を行う

JSにおける同期処理の例
- 変数宣言 (`const a = 1`)
- Consoleオブジェクト (`console.log('foo')`)

Pros.
- 直感的で理解がしやすい (コードの記述順に処理するため)

Cons.
- ネットワーク通信などCPUの待ち時間が発生する処理でも、他の処理ができない

### 非同期処理とは
特徴
- ひとつの処理が終わるのを待たずに、次の処理を行う
- コードの記述とは違う順番で処理を行うことが多い

JSにおける非同期処理の例
- setTimeout (`setTimeout(() => 'bar', 1000)`)
- Fetch API (`fetch('https://example.com')`)

Pros.
- ネットワーク通信などCPUの待ち時間が発生する処理を非同期処理にすることで、他の処理を実行できる

Cons.
- コードを理解するための難易度が上がる (直感とは異なる評価順になるため)

### なぜ非同期処理が必要なのか？
処理の効率化のためです。JSの実行環境であるブラウザは、基本的にシングルスレッドでJSを実行します。シングルスレッドはプログラムの処理単位の用語で、同時に1つのこと処理しか実行できない(1つのCPUだけで処理する)ことを表しています。そのため、ネットワーク通信のような待ち時間でCPUが暇しているのに他の処理ができない同期処理より、CPUの待ち時間に他の処理を行える非同期処理がよく使われます。

JS自体の処理の効率化以外に、画面の描画に関するパフォーマンスを落とさないためという理由もあります。ブラウザのJSを実行するスレッドのことを、メインスレッドやUIスレッドと呼びます。このメインスレッドはJSの実行以外に、HTML/CSSなどを使った画面の描画処理も行います。そのため、もしJSで重たい処理がある場合、画面の描画処理も同様に止めらてしまいます。

メインスレッドやブラウザが画面表示するまでの流れを知りたい人は、以下を読んでみるといいでしょう。
- [ブラウザのしくみ: 最新ウェブブラウザの内部構造 - HTML5 Rocks](https://www.html5rocks.com/ja/tutorials/internals/howbrowserswork/)
- [Webフロントエンド ハイパフォーマンス チューニング](https://gihyo.jp/book/2017/978-4-7741-8967-3)

(extra)
- ブラウザでJSをマルチスレッド(同時に複数の処理を実行できる)で動かす方法もあります。`Web Worker`などで調べてみてください。

### 実例で見る
- 01-sync-and-async/description.html
- 01-sync-and-async/description2.html

## 非同期処理の実装方法
ここまでみてきた通り、JSでは非同期処理が重要な役割を果たすため、実装方法も複数用意されています。ひとまず、次の3つを知っていれば大体のケースは対応できるでしょう。

- コールバック関数
- Promise
- async/await

### コールバック関数
非同期処理の引数に関数を渡して、非同期処理の完了時に呼び出す方法

Pros.
- シンプルな非同期処理なら簡単に書ける

Cons.
- ネストが深くなると可読性が下がったり、コード修正時の差分が理解しづらい(Callback Hell)
- エラーハンドリングが難しい
  - (extra) [非同期処理:コールバック/Promise/Async Function · JavaScript Primer #jsprimer](https://jsprimer.net/basic/async/#async-processing-and-error-handling)などを読んでみてください

#### 実例で見る
- 02-callback/description.html

### Promise
非同期処理を抽象化した`Promise`オブジェクトを使って、処理を直列に並べることなどを可能にする方法

Pros.
- 処理が読みやすくなる (`.then()`を使うことで、ネストせずに処理を実装できる)
- エラーハンドリングがしやすくなった

#### 実例で見る
- 03-promise/description.html

### async/await
ES2017で導入された構文で、Promiseをより直感的に書けるようにできる方法。Promiseがベースになっているため、利用するにはPromiseを理解する必要がある。

async
- 非同期処理を行う関数定義に使うキーワード
- `async`をつけた関数は、必ずPromiseインスタンスを返す関数になる

await
- Promiseインスタンスの非同期処理が完了するまで待つ式で、`await Promiseインスタンス`のように書く
  - Promiseにおける`.then()`のシンタックスシュガー(機能は同じで、別の書き方をできるようにしたもの)と考えてよい
- 基本的に`async`がついた関数の中じゃないと使えない (`Top-level await`という例外もある)

Pros.
- Promiseより直感的に非同期処理が実装できる

#### 実例で見る
- 04-async-await/description.html

